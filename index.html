<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Material Sign In/Out Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load PapaParse for Robust CSV Handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        /* Custom Styles for Inter Font and Input Fixes */
        body { font-family: 'Inter', sans-serif; }

        /* Firefox number input fix */
        input[type="number"] { -moz-appearance: textfield; } 
        /* Chrome, Safari number input fix */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        /* Style for sticky table header */
        #materialTable thead th, #reviewTable thead th {
            position: sticky;
            top: 0;
            background-color: #f3f4f6; /* Tailwind gray-100 */
            z-index: 10;
        }

        /* Responsive Table Container Height */
        .table-container {
            max-height: 70vh; /* Use viewport height for better responsiveness */
            overflow-y: auto;
            border: 1px solid #e5e7eb; /* Tailwind gray-200 */
            border-radius: 0.5rem;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#0056b3',
                        'success-green': '#28a745',
                        'danger-red': '#dc3545',
                        'warning-yellow': '#ffc107',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 p-4 sm:p-6">

<!-- Custom Modal Overlay (replacing alerts and confirms) -->
<div id="custom-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 z-[1000] hidden justify-center items-center">
    <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-11/12 text-center">
        <h4 id="modal-title" class="text-xl font-bold text-primary-blue mb-3"></h4>
        <p id="modal-message" class="mb-5 text-gray-700"></p>
        <div id="modal-buttons" class="flex justify-center gap-3">
            <!-- Buttons injected by JS -->
        </div>
    </div>
</div>

<!-- Datalist for storing WO history -->
<datalist id="wo-history-list"></datalist>

<!-- VIEW 0: LOGIN SCREEN (NEW) -->
<div id="view-login" class="fixed inset-0 bg-gray-100 flex flex-col justify-center items-center z-50">
    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
        <h1 class="text-2xl font-extrabold text-gray-800 mb-2">Restricted Access</h1>
        <p class="text-gray-500 mb-6">Please enter the passcode to access the Material Tracker.</p>
        
        <input type="password" id="passcodeInput" 
               class="w-full p-3 border-2 border-gray-300 rounded-lg text-center text-2xl tracking-widest mb-4 focus:border-primary-blue focus:ring-2 focus:ring-blue-200 outline-none transition" 
               placeholder="****"
               onkeydown="if(event.key === 'Enter') checkPasscode()">
               
        <button onclick="checkPasscode()" 
                class="w-full py-3 bg-primary-blue text-white font-bold rounded-lg hover:bg-blue-700 transition shadow-md">
            Enter Tracker
        </button>
        <p id="login-error" class="text-danger-red font-bold mt-3 hidden">Incorrect Passcode</p>
    </div>
</div>

<div class="container max-w-6xl mx-auto bg-white p-4 sm:p-6 rounded-xl shadow-2xl">
    
    <!-- VIEW 1: TABLE OF CONTENTS (Now hidden by default) -->
    <div id="view-toc" class="hidden">
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center pb-4 mb-4 border-b-2 border-gray-200">
            <h1 class="text-2xl font-extrabold text-gray-800">Material Categories</h1>
            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 mt-3 sm:mt-0">
                <div class="flex items-center gap-2">
                    <!-- Data Status Badge -->
                    <span id="db-status-badge" class="px-3 py-1.5 rounded-md text-sm font-semibold shadow-sm"></span>
                    <!-- Sync Button -->
                    <button onclick="syncFromEmbeddedSheet()" title="Force Sync from Google Sheets" 
                            class="p-2 bg-white text-gray-600 border border-gray-300 rounded-md hover:bg-gray-100 hover:text-primary-blue transition shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                </div>
                <button class="w-full sm:w-auto px-4 py-2 bg-success-green text-white font-bold rounded-lg hover:bg-green-700 transition duration-150 shadow-md" onclick="goToReview()">
                    Review List (<span id="cart-counter">0</span>) &rarr;
                </button>
            </div>
        </header>
        
        <!-- NEW: Global Search Bar -->
        <div class="mb-8 relative">
            <label for="globalSearch" class="sr-only">Search All Materials</label>
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <!-- Heroicon name: solid/search -->
                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                </div>
                <input type="text" id="globalSearch" 
                       class="block w-full pl-10 pr-24 p-4 border-2 border-gray-300 rounded-xl leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:border-primary-blue focus:ring-2 focus:ring-blue-300 sm:text-lg transition shadow-md" 
                       placeholder="Quick search all materials (CU, ID, Description)..."
                       onkeydown="if(event.key === 'Enter') performGlobalSearch(this.value)">
                <div class="absolute inset-y-0 right-0 flex py-2 pr-2">
                    <button onclick="performGlobalSearch(document.getElementById('globalSearch').value)" 
                            class="px-6 bg-primary-blue text-white font-bold rounded-lg hover:bg-blue-700 transition duration-150">
                        Search
                    </button>
                </div>
            </div>
        </div>

        <p class="mb-5 text-gray-600">Please select a category to view materials or go directly to your review list.</p>

        <div id="toc-buttons" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <!-- Category buttons injected by JS -->
            <div class="p-6 text-center text-gray-500 font-semibold col-span-full">Loading categories...</div>
        </div>
    </div>

    <!-- VIEW 2: SELECTION PAGE (Now hidden by default) -->
    <div id="view-selection" class="hidden">
        <!-- UPDATED HEADER: Single line layout -->
        <header class="flex flex-wrap items-center justify-between gap-2 pb-3 mb-2 border-b border-gray-200">
            
            <div class="flex items-center gap-3 overflow-hidden">
                <h1 class="text-xl sm:text-2xl font-extrabold text-gray-800 whitespace-nowrap">Material Tracker</h1>
                
                <!-- Category Display -->
                <div class="flex items-center bg-blue-50 border border-blue-200 rounded-md px-3 py-1.5 shadow-sm whitespace-nowrap">
                    <span class="text-xs font-semibold text-gray-500 mr-2 uppercase tracking-wider hidden md:inline">Category:</span>
                    <strong id="current-filter-category" class="text-primary-blue text-sm sm:text-base">All Materials</strong>
                    <!-- Clear button removed -->
                </div>
            </div>

            <!-- Buttons -->
            <div class="flex items-center gap-2 flex-shrink-0">
                <button class="px-3 py-1.5 bg-gray-500 text-white text-sm font-bold rounded-md hover:bg-gray-600 transition duration-150 whitespace-nowrap" onclick="goToToc()">
                    &larr; Categories
                </button>
                <button class="px-3 py-1.5 bg-success-green text-white text-sm font-bold rounded-md hover:bg-green-700 transition duration-150 shadow-md whitespace-nowrap" onclick="goToReview()">
                    Review (<span id="selection-cart-counter">0</span>) &rarr;
                </button>
            </div>
        </header>

        <!-- UPDATED COMPACT SEARCH (Now with Manual Search Button) -->
        <div class="mb-3 flex gap-2">
            <div class="relative flex-grow">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                </div>
                <!-- Removed onkeyup, added onkeydown for Enter key -->
                <input type="text" id="searchInput" class="w-full pl-9 pr-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-300 focus:border-primary-blue transition shadow-sm" 
                       placeholder="Search materials by CU, ID, or Description..." 
                       onkeydown="if(event.key === 'Enter') filterMaterials()">
            </div>
            <!-- New Manual Search Button -->
            <button onclick="filterMaterials()" class="px-4 py-2 bg-primary-blue text-white font-bold rounded-md hover:bg-blue-700 transition shadow-sm text-sm">
                Search
            </button>
        </div>

        <!-- PAGINATION CONTROLS (UPDATED) -->
        <div id="pagination-top" class="mb-2 bg-gray-50 p-2 rounded-md border border-gray-200 hidden">
            <!-- Injected via JS -->
        </div>
        
        <div class="table-container">
            <table id="materialTable" class="w-full text-left">
                <thead>
                    <tr class="text-sm uppercase text-gray-600 border-b border-gray-300">
                        <!-- UPDATED: Swapped Column Order -->
                        <th class="py-3 px-4">ID</th>
                        <th class="py-3 px-4">CU / Description</th>
                        <th class="py-3 px-4">Controls (WO / Type / Loc / Qty)</th>
                    </tr>
                </thead>
                <tbody id="materialTableBody">
                    <!-- Data injected via JS -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- VIEW 3: REVIEW PAGE -->
    <div id="view-review" class="hidden">
        <header class="flex justify-between items-center pb-4 mb-4 border-b-2 border-gray-200">
            <h1 class="text-2xl font-extrabold text-gray-800">Review & Send</h1>
            <button class="px-4 py-2 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 transition duration-150 shadow-md" onclick="goBack()">
                &larr; Back to Selection
            </button>
        </header>

        <div class="bg-gray-200 p-4 rounded-lg mb-6 border border-gray-300">
            <p class="font-semibold text-gray-800">Total Transactions Selected: <span id="totalItemsCount" class="text-primary-blue font-extrabold">0</span></p>
        </div>

        <h3 class="text-xl font-semibold mb-3 text-gray-700">Material List Summary</h3>
        <div class="table-container">
            <table id="reviewTable" class="w-full text-left">
                <thead>
                    <tr class="text-sm uppercase text-gray-600 border-b border-gray-300">
                        <th class="py-3 px-4">WO #</th>
                        <th class="py-3 px-4">Type</th>
                        <th class="py-3 px-4">Location</th>
                        <th class="py-3 px-4">ID</th>
                        <th class="py-3 px-4">Description</th>
                        <th class="py-3 px-4">Qty</th>
                        <th class="py-3 px-4">Action</th>
                    </tr>
                </thead>
                <tbody id="reviewTableBody">
                    <!-- Selected items injected via JS -->
                </tbody>
            </table>
        </div>

        <div class="mt-8 pt-6 border-t border-gray-300 flex flex-col sm:flex-row gap-4">
            <button class="flex-1 px-6 py-4 text-lg bg-gray-600 text-white font-extrabold rounded-lg hover:bg-gray-700 transition duration-150 shadow-xl" onclick="downloadCSV()">
                Download CSV
            </button>
            <button class="flex-1 px-6 py-4 text-lg bg-success-green text-white font-extrabold rounded-lg hover:bg-green-700 transition duration-150 shadow-xl" onclick="openEmailDraft()">
                Send List (Open Email App)
            </button>
        </div>
    </div>

</div>

<script type="module">
    // --- CANVAS ENVIRONMENT VARIABLES (Mandatory inclusion for context) ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    console.log(`App ID: ${appId}, Firebase Config Loaded: ${Object.keys(firebaseConfig).length > 0}`);
    // ---------------------------------------------------------------------

    // Polyfill for crypto.randomUUID for broader compatibility
    if (typeof crypto.randomUUID !== 'function') {
        crypto.randomUUID = function() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        };
    }

    // --- UPDATED: LINK TO YOUR SPECIFIC SHEET ---
    const EMBEDDED_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSBmb-80reVNE4qZ_OvQ3_USfQNJHsjnmFvHXE733_4ijrIlsSvR0Mz9Wl6cbXcBtbod98pJrN4HPyL/pub?output=csv";
    
    // --- LOGIN CONFIGURATION ---
    const APP_PASSCODE = "1945"; 
    // ---------------------------

    // --- 1. STATE VARIABLES ---
    let materialDB = [];
    let woHistory = [];
    let cart = [];

    // PAGINATION VARIABLES
    let currentPage = 1;
    const itemsPerPage = 200;
    let currentFilteredList = []; 
    
    // NEW: Static list of categories for the Table of Contents
    const STATIC_CATEGORIES = [
        "Arresters",
        "Brackets", // <--- Added Here
        "Capacitors",
        "Conduit",
        "Controllers",
        "Crossarms",
        "Enclosures",
        "Fuse/Cutout",
        "Indicators",
        "Light/Fixtures",
        "Poles",
        "Reclosers",
        "Regulators",
        "Concrete/Structures",
        "Switches",
        "Switchgears",
        "Transformers",
        "Wire/Cables"
    ];
    
    // NEW: Mappings to handle differences between Button Name and Google Sheet Data
    const CATEGORY_ALIASES = {
        "Brackets": ["Brackets", "Bracket"], // <--- Added Alias Mapping
        "Fuse/Cutout": ["Fuse Cutouts", "Fuse Cutout", "Fuse/Cutout", "Fuse / Cutout"],
        "Light/Fixtures": ["Light Fixtures", "Light Fixture", "Light/Fixtures", "Light / Fixtures"],
        "Concrete/Structures": ["Concrete Structures", "Concrete Structure", "Concrete/Structures", "Concrete / Structures"]
    };

    // UPDATED Sample data to use the specific categories
    const sampleData = [
        { cu: "Distribution Arrester, 10kV", id: "ARR-10KV", desc: "Polymer distribution class arrester", category: "Arresters" },
        { cu: "Power Capacitor, 15kVAR", id: "CAP-15KVAR", desc: "Single phase 15kVAR capacitor bank", category: "Capacitors" },
        { cu: "Rigid Steel Conduit, 1in", id: "CON-RSC-1IN", desc: "1 inch diameter rigid steel conduit", category: "Conduit" },
        { cu: "Pole, Wood Class 4, 40ft", id: "POLE-W4-40", desc: "Treated wood pole, class 4, 40 feet", category: "Poles" },
        { cu: "Transformer, Pad Mount, 50kVA", id: "XFR-PM-50", desc: "50kVA pad mount distribution transformer", category: "Transformers" },
        { cu: "Aluminum Conductor, 4/0 ACSR", id: "WIRE-4/0AS", desc: "4/0 ACSR bare aluminum wire", category: "Wire/Cables" }
    ];

    // --- CUSTOM MODAL DIALOG FUNCTIONS (Replacing alert() and confirm()) ---

    /**
     * Shows a custom alert modal.
     * @param {string} message The message to display.
     * @param {string} [title='Alert'] The title of the modal.
     */
    function showCustomAlert(message, title = 'Attention') {
        const modal = document.getElementById('custom-modal');
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-message').innerText = message;
        
        const buttons = document.getElementById('modal-buttons');
        buttons.innerHTML = `<button class="px-4 py-2 bg-primary-blue text-white font-bold rounded-lg hover:bg-blue-700 transition duration-150" onclick="closeModal()">OK</button>`;
        
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    /**
     * Shows a custom confirmation modal.
     * @param {string} message The confirmation message.
     * @param {function} callback The function to execute if 'Yes' is clicked.
     */
    function showCustomConfirm(message, callback) {
        const modal = document.getElementById('custom-modal');
        document.getElementById('modal-title').innerText = 'Confirm Action';
        document.getElementById('modal-message').innerText = message;
        
        const buttons = document.getElementById('modal-buttons');
        buttons.innerHTML = `
            <button class="px-4 py-2 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 transition duration-150" onclick="closeModal(); callback(false);">Cancel</button>
            <button class="px-4 py-2 bg-success-green text-white font-bold rounded-lg hover:bg-green-700 transition duration-150" onclick="closeModal(); callback(true);">Yes, Proceed</button>
        `;
        
        // Assign callback to modal context for execution
        window.callback = callback;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeModal() {
        const modal = document.getElementById('custom-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        window.callback = null; // Clean up callback
    }

    // Expose modal functions globally for HTML calls
    window.showCustomAlert = showCustomAlert;
    window.showCustomConfirm = showCustomConfirm;
    window.closeModal = closeModal;


    // --- 2. INITIALIZATION & SYNC ---
    window.onload = () => {
        // NOTE: We do NOT load data immediately. We wait for passcode check.
        // If user previously logged in (sessionStorage), we can skip.
        if (sessionStorage.getItem('isLoggedIn') === 'true') {
            unlockApp();
        }
    };

    // --- LOGIN LOGIC ---
    function checkPasscode() {
        const input = document.getElementById('passcodeInput');
        const errorMsg = document.getElementById('login-error');
        
        if (input.value === APP_PASSCODE) {
            sessionStorage.setItem('isLoggedIn', 'true');
            unlockApp();
        } else {
            errorMsg.classList.remove('hidden');
            input.value = '';
            input.focus();
        }
    }
    
    function unlockApp() {
        document.getElementById('view-login').classList.add('hidden');
        document.getElementById('view-toc').classList.remove('hidden');
        
        // Start the app logic now
        loadSettings();
        initialLoadAndSync();
        updateCartCounter();
    }
    
    window.checkPasscode = checkPasscode;

    function loadSettings() {
        const savedWOs = localStorage.getItem('woHistory');
        if(savedWOs) woHistory = JSON.parse(savedWOs);
        updateDatalist();
    }

    function updateCartCounter() {
        document.getElementById('cart-counter').innerText = cart.length;
        document.getElementById('selection-cart-counter').innerText = cart.length;
    }

    function initialLoadAndSync() {
        // Check if the URL is the placeholder. If so, use cached/sample data.
        if (EMBEDDED_SHEET_URL.includes("INSERT_YOUR_PUBLISHED_GOOGLE_SHEET_CSV_LINK_HERE")) {
            loadDatabaseFromLocalStorage();
        } else {
            syncFromEmbeddedSheet();
        }
    }

    // Helper to clean badge classes
    function updateBadge(html, colorClass, removeClasses) {
        const statusBadge = document.getElementById('db-status-badge');
        if(!statusBadge) return; // Safety check
        statusBadge.innerHTML = html;
        statusBadge.classList.remove(...removeClasses);
        statusBadge.classList.add(colorClass);
    }

    function loadDatabaseFromLocalStorage() {
        const savedData = localStorage.getItem('materialDB');
        const allColorClasses = ['bg-blue-100', 'text-primary-blue', 'bg-yellow-100', 'text-yellow-800', 'bg-red-100', 'text-danger-red', 'bg-blue-50', 'text-blue-600', 'bg-green-100', 'text-success-green'];
        
        if (savedData) {
            materialDB = JSON.parse(savedData);
            updateBadge(
                `<span class="text-lg">&#128214;</span> ${materialDB.length} Items (Cached)`, 
                'bg-blue-100', 
                allColorClasses
            );
            const badge = document.getElementById('db-status-badge');
            if(badge) badge.classList.add('text-primary-blue');
        } else {
            materialDB = sampleData;
            updateBadge(
                `<span class="text-lg">&#9888;</span> Sample Data`, 
                'bg-yellow-100', 
                allColorClasses
            );
            const badge = document.getElementById('db-status-badge');
            if(badge) badge.classList.add('text-yellow-800');
        }
        
        renderToc(); // Only need to render the static TOC now
    }

    async function syncFromEmbeddedSheet() {
        const statusBadge = document.getElementById('db-status-badge');
        if(!statusBadge) return;

        const allColorClasses = ['bg-blue-100', 'text-primary-blue', 'bg-yellow-100', 'text-yellow-800', 'bg-red-100', 'text-danger-red', 'bg-blue-50', 'text-blue-600', 'bg-green-100', 'text-success-green'];
        
        updateBadge(
            `<span class="text-lg">&#8635;</span> Syncing...`, 
            'bg-blue-50', 
            allColorClasses
        );
        statusBadge.classList.add('text-blue-600');

        try {
            // --- OPTION 2 CLEAN VERSION: DIRECT ACCESS (NO PROXY) ---
            // Since we are hosting on GitHub, we attempt a direct fetch first.
            const originalUrl = EMBEDDED_SHEET_URL + "&t=" + new Date().getTime();
            
            const response = await fetch(originalUrl);
            
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const csvText = await response.text();
            
            const loadedCount = parseAndSaveCSV(csvText);
            
            if (loadedCount > 0) {
                updateBadge(
                    `<span class="text-lg">&#9989;</span> ${loadedCount} Items (Live)`, 
                    'bg-green-100', 
                    allColorClasses
                );
                statusBadge.classList.add('text-success-green');
            } else {
                throw new Error("Parsed 0 items");
            }

        } catch (error) {
            console.error('Error syncing embedded sheet:', error);
            
            updateBadge(
                `<span class="text-lg">&#10060;</span> Sync Failed!`, 
                'bg-red-100', 
                allColorClasses
            );
            statusBadge.classList.add('text-danger-red');
            
            // Fallback to local storage on fetch error
            setTimeout(() => {
                loadDatabaseFromLocalStorage();
            }, 2000); // Wait 2 seconds so user sees the "Failed" message before loading cache
        }
    }
    
    // Expose sync function globally
    window.syncFromEmbeddedSheet = syncFromEmbeddedSheet;

    // --- SHARED CSV PARSER (UPDATED WITH PAPAPARSE) ---
    function parseAndSaveCSV(csvText) {
        // Use PapaParse to handle quoted newlines and commas correctly
        const results = Papa.parse(csvText, {
            header: false, // We rely on column index, not names (Column A=0, B=1, etc)
            skipEmptyLines: true
        });

        const rows = results.data;
        const newData = [];

        // Assume row 0 is header, start loop at 1
        for (let i = 1; i < rows.length; i++) {
            const cols = rows[i];
            // Ensure we have enough columns. 
            // We need at least ID (0) and CU (1).
            if (cols.length >= 2 && cols[0] && cols[1]) {
                newData.push({
                    id: cols[0].trim(),
                    cu: cols[1].trim(),
                    desc: cols[2] ? cols[2].trim() : 'No Description',
                    category: cols[3] ? cols[3].trim() : 'Uncategorized'
                });
            }
        }
        
        if (newData.length > 0) {
             materialDB = newData;
             localStorage.setItem('materialDB', JSON.stringify(materialDB));
             renderToc();
             return newData.length;
        } else {
             console.warn("CSV Parsing failed or empty");
             return 0;
        }
    }
    
    // --- 3. TOC & NAVIGATION (MODIFIED) ---
    
    function renderToc() {
        const container = document.getElementById('toc-buttons');
        if(!container) return;
        container.innerHTML = ''; // Clear "Loading..."
        
        // Add "All Materials" button first
        container.innerHTML += `
            <button class="w-full p-6 bg-primary-blue text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition duration-150" onclick="goToCategory('All Materials')">
                View All Materials
            </button>
        `;
        
        // Add buttons for each category using the STATIC_CATEGORIES list
        STATIC_CATEGORIES.forEach(category => {
            // FIX: Changed class_name to class
            container.innerHTML += `
                <button class="w-full p-6 bg-white text-primary-blue border-2 border-primary-blue font-bold rounded-lg shadow-sm hover:bg-blue-50 transition duration-150" onclick="goToCategory('${category}')">
                    ${category}
                </button>
            `;
        });
    }
    
    function goToToc() {
        document.getElementById('view-selection').classList.add('hidden');
        document.getElementById('view-review').classList.add('hidden');
        document.getElementById('view-toc').classList.remove('hidden');
        document.getElementById('searchInput').value = ''; // Clear search on exit
        document.getElementById('globalSearch').value = ''; // Clear global search on return
    }
    
    function goToCategory(categoryName) {
        document.getElementById('current-filter-category').innerText = categoryName;
        document.getElementById('searchInput').value = ''; // Clear search field
        
        document.getElementById('view-toc').classList.add('hidden');
        document.getElementById('view-selection').classList.remove('hidden');
        
        // Logic for clear-filter-btn removed
        
        filterMaterials(); // Render the filtered list
    }
    
    function clearCategoryFilter() {
        document.getElementById('current-filter-category').innerText = 'All Materials';
        // Logic for clear-filter-btn removed
        filterMaterials();
    }
    
    // Expose new navigation functions globally
    window.goToToc = goToToc;
    window.goToCategory = goToCategory;
    window.clearCategoryFilter = clearCategoryFilter;
    
    // NEW: Perform Global Search Function
    function performGlobalSearch(term) {
        if (!term || term.trim() === '') {
            showCustomAlert("Please enter a search term.", "Search Empty");
            return;
        }
        
        // 1. Switch to 'All Materials' context (this clears the inner search input)
        goToCategory('All Materials');
        
        // 2. Set the inner search input to our global term
        const innerSearchInput = document.getElementById('searchInput');
        innerSearchInput.value = term;
        
        // 3. Trigger the filter function to update the table
        filterMaterials();
    }
    window.performGlobalSearch = performGlobalSearch;


    // --- 4. WO HISTORY LOGIC ---
    function registerWO(wo) {
        const val = wo.trim().toUpperCase();
        if(val && !woHistory.includes(val)) {
            woHistory.push(val);
            localStorage.setItem('woHistory', JSON.stringify(woHistory)); // Save WOs
            updateDatalist();
        }
    }

    function quickAddFromRow(id) {
        const input = document.getElementById(`wo-${id}`);
        const val = input.value.trim();

        if(!val) {
            showCustomAlert("Please enter a Work Order Number in the box first to add it to the quick list.", "WO Required");
            input.focus();
            return;
        }

        // NEW: Validation for hyphen
        if (!val.includes('-')) {
            showCustomAlert("Work Order Number must contain a hyphen '-' followed by a task number (e.g., 56891115-1).", "Invalid Format");
            input.focus();
            return;
        }

        registerWO(val);
        const btn = document.getElementById(`plus-${id}`);
        const originalText = btn.innerText;
        btn.innerText = "âœ“";
        btn.classList.add('text-success-green', 'border-success-green');
        setTimeout(() => {
            btn.innerText = "+";
            btn.classList.remove('text-success-green', 'border-success-green');
        }, 1000);
    }

    function updateDatalist() {
        const dl = document.getElementById('wo-history-list');
        dl.innerHTML = woHistory.map(wo => `<option value="${wo}">`).join('');
    }
    
    // Expose WO history functions globally
    window.quickAddFromRow = quickAddFromRow;


    // --- 5. MATERIAL & SEARCH LOGIC (MODIFIED with Pagination) ---
    
    // Handles changes from search bar OR category buttons
    function filterMaterials() {
        const category = document.getElementById('current-filter-category').innerText;
        const term = document.getElementById('searchInput').value.toLowerCase();
        
        // 1. Start with the full DB
        let baseData = materialDB;
        
        // 2. Filter by Category
        if (category !== 'All Materials') {
            baseData = materialDB.filter(item => {
                const itemCat = item.category.trim();
                const targetCat = category.trim();
                
                // Check 1: Exact Match
                if (itemCat === targetCat) return true;
                
                // Check 2: Alias Match
                if (CATEGORY_ALIASES[targetCat] && CATEGORY_ALIASES[targetCat].includes(itemCat)) {
                    return true;
                }
                
                return false;
            });
        }
        
        // 3. Filter by Search Term
        if (term.length > 0) {
            baseData = baseData.filter(item => 
                (item.cu && item.cu.toLowerCase().includes(term)) ||
                (item.id && item.id.toLowerCase().includes(term)) ||
                (item.desc && item.desc.toLowerCase().includes(term))
            );
        }

        // 4. Store filtered result
        currentFilteredList = baseData;

        // 5. Reset to Page 1
        currentPage = 1;

        // 6. Render
        renderPaginationAndTable();

        // Scroll table container to top
        const container = document.querySelector('.table-container');
        if (container) container.scrollTop = 0;
    }

    // New Render Function handling Pagination
    function renderPaginationAndTable() {
        // 1. Calculate Pagination
        const totalItems = currentFilteredList.length;
        const totalPages = Math.ceil(totalItems / itemsPerPage);

        // Ensure currentPage is safe
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;
        if (totalItems === 0) currentPage = 1;

        // 2. Show/Hide Pagination Controls
        const paginationDiv = document.getElementById('pagination-top');
        
        if (totalItems > itemsPerPage) {
            paginationDiv.classList.remove('hidden');
            
            // Generate Page Number Buttons
            let pageButtonsHTML = '';
            // We limit the max visible buttons if there are too many (optional safety), 
            // but for ~20 pages (4000 items / 200), showing all is fine and requested.
            for (let i = 1; i <= totalPages; i++) {
                const isActive = i === currentPage;
                const activeClass = isActive 
                    ? 'bg-primary-blue text-white border-primary-blue font-bold shadow-sm' 
                    : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-100 hover:text-primary-blue';
                
                pageButtonsHTML += `<button onclick="goToPage(${i})" class="px-3 py-1 border rounded-md text-sm transition ${activeClass}">${i}</button>`;
            }

            paginationDiv.innerHTML = `
                <div class="flex flex-wrap items-center justify-center gap-2">
                      <button onclick="changePage(-1)" class="px-3 py-1 bg-white border border-gray-300 rounded-md hover:bg-gray-100 disabled:opacity-50 shadow-sm font-semibold" ${currentPage === 1 ? 'disabled' : ''}>&larr; Prev</button>
                      
                      <div class="flex flex-wrap justify-center gap-1">
                         ${pageButtonsHTML}
                      </div>
                      
                      <button onclick="changePage(1)" class="px-3 py-1 bg-white border border-gray-300 rounded-md hover:bg-gray-100 disabled:opacity-50 shadow-sm font-semibold" ${currentPage === totalPages ? 'disabled' : ''}>Next &rarr;</button>
                      
                      <span class="ml-2 text-xs text-gray-500 font-medium hidden sm:inline-block">(${totalItems} items)</span>
                </div>
            `;
        } else {
            paginationDiv.classList.add('hidden');
            paginationDiv.innerHTML = '';
        }

        // 3. Slice Data
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const displayData = currentFilteredList.slice(startIndex, endIndex);

        // 4. Render Table Rows
        const tbody = document.getElementById('materialTableBody');
        tbody.innerHTML = "";
        
        if (displayData.length === 0) {
            const currentCategory = document.getElementById('current-filter-category').innerText;
            const searchTerm = document.getElementById('searchInput').value;
            let message = "No materials found.";
            if (searchTerm) {
                message = `No materials found for "${searchTerm}" in "${currentCategory}".`;
            } else {
                message = `No materials found in "${currentCategory}".`;
            }
            tbody.innerHTML = `<tr><td colspan="3" class="p-6 text-center text-gray-500 font-semibold">${message}</td></tr>`;
            return;
        }

        displayData.forEach(item => {
            const safeId = item.id.replace(/[^a-zA-Z0-9-_]/g, ''); 

            // UPDATED: Swapped Column Content
            const row = `
                <tr class="hover:bg-gray-50 transition duration-100 border-b border-gray-100">
                    <td class="py-3 px-4 align-top"><strong>${item.cu}</strong></td>
                    <td class="py-3 px-4 align-top">
                        <strong class="text-gray-900">${item.id}</strong><br>
                        <span class="text-xs text-gray-500">${item.desc}</span>
                    </td>
                    <td class="py-3 px-4 align-top">
                        <div class="flex flex-col space-y-2 lg:flex-row lg:space-y-0 lg:space-x-2 items-start lg:items-center">
                            
                            <!-- WO Input & Quick Add -->
                            <div class="flex items-center">
                                <input type="text" id="wo-${safeId}" class="p-2 border border-gray-300 rounded-l-lg wo-input w-24 lg:w-28 text-sm" placeholder="WO#" list="wo-history-list">
                                <button id="plus-${safeId}" class="p-2 border border-gray-300 rounded-r-lg bg-gray-100 text-gray-600 text-sm font-bold hover:bg-gray-200 transition duration-150 shadow-sm" title="Add WO to Quick List" onclick="quickAddFromRow('${safeId}')">+</button>
                            </div>

                            <!-- Type Select -->
                            <select id="type-${safeId}" class="p-2 border border-gray-300 rounded-lg type-select w-20 lg:w-24 text-sm">
                                <option value="Issue">Issue</option>
                                <option value="Credit">Credit</option>
                            </select>

                            <!-- NEW: Location (From/To) Select -->
                            <select id="source-${safeId}" class="p-2 border border-gray-300 rounded-lg source-select w-32 lg:w-40 text-sm" title="Source/Destination">
                                <option value="Pike Sebring">Pike Sebring</option>
                                <option value="Pike Frostproof">Pike Frostproof</option>
                                <option value="Pike Dundee">Pike Dundee</option>
                                <option value="Jingoli HC">Jingoli HC</option>
                                <option value="Jingoli Orlando">Jingoli Orlando</option>
                            </select>

                            <!-- Quantity Input -->
                            <input type="number" min="1" value="1" id="qty-${safeId}" class="p-2 border border-gray-300 rounded-lg qty-input w-16 text-center text-sm">
                            
                            <!-- Add Button -->
                            <button class="p-2 bg-primary-blue text-white font-bold rounded-lg hover:bg-blue-700 transition duration-150 shadow-md flex-shrink-0" onclick="addToCart('${item.id}', '${safeId}')">
                                Add
                            </button>
                        </div>
                        <div id="preview-${safeId}" class="flex flex-wrap gap-2 mt-2">
                            ${generatePreviewHTML(item.id)}
                        </div>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }
    
    // Change page function
    window.changePage = function(direction) {
        currentPage += direction;
        renderPaginationAndTable();
        // Scroll table container to top for better UX
        document.querySelector('.table-container').scrollTop = 0;
    };

    // Go to specific page function
    window.goToPage = function(pageNumber) {
        currentPage = pageNumber;
        renderPaginationAndTable();
        document.querySelector('.table-container').scrollTop = 0;
    };
    
    window.filterMaterials = filterMaterials;
    window.addToCart = addToCart;

    function generatePreviewHTML(materialId) {
        const items = cart.filter(c => c.id === materialId);
        if (items.length === 0) return '';

        return items.map(item => {
            const colorClass = item.type === 'Issue' ? 'border-primary-blue' : 'border-danger-red';
            const bgColorClass = item.type === 'Issue' ? 'bg-blue-50' : 'bg-red-50';
            const textColorClass = item.type === 'Issue' ? 'text-primary-blue' : 'text-danger-red';

            return `<span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-md border-l-4 ${colorClass} ${bgColorClass} shadow-sm">
                <strong class="mr-1 font-bold ${textColorClass}">${item.wo}</strong> 
                <span class="text-gray-600 mr-1">(${item.source})</span>
                ${item.type}: ${item.qty}
                <span class="ml-2 text-gray-500 cursor-pointer font-extrabold hover:text-gray-800 transition" title="Remove" onclick="removeFromPreview('${item.transactionId}', '${materialId}')">&times;</span>
            </span>`;
        }).join('');
    }
    
    window.removeFromPreview = removeFromPreview;

    function removeFromPreview(transactionId, materialId) {
        const index = cart.findIndex(x => x.transactionId === transactionId);
        
        if (index > -1) {
            cart.splice(index, 1);
            const safeId = materialId.replace(/[^a-zA-Z0-9-_]/g, '');
            const container = document.getElementById(`preview-${safeId}`);
            if(container) {
                 container.innerHTML = generatePreviewHTML(materialId);
                 updateCartCounter();
            }
        }
    }


    // --- 6. CART LOGIC ---
    function addToCart(originalId, safeId) {
        const itemObj = materialDB.find(x => x.id === originalId);
        const qtyInput = document.getElementById(`qty-${safeId}`);
        const woInput = document.getElementById(`wo-${safeId}`);
        const typeInput = document.getElementById(`type-${safeId}`);
        const sourceInput = document.getElementById(`source-${safeId}`); // New
        
        const addButton = document.querySelector(`#materialTableBody button[onclick*="addToCart('${originalId}', '${safeId}')"]`);


        const qty = parseInt(qtyInput.value);
        const wo = woInput.value.trim().toUpperCase();
        const type = typeInput.value;
        const source = sourceInput.value; // New

        if (!wo) {
            showCustomAlert("Please enter a Work Order Number before adding an item.", "WO Required");
            woInput.focus();
            return;
        }

        // NEW: Validation for hyphen
        if (!wo.includes('-')) {
            showCustomAlert("Work Order Number must contain a hyphen '-' followed by a task number (e.g., 56891115-1).", "Invalid Format");
            woInput.focus();
            return;
        }

        if (qty <= 0 || isNaN(qty)) {
             showCustomAlert("Quantity must be a positive number.", "Invalid Quantity");
             qtyInput.focus();
             return;
        }

        registerWO(wo);

        // Check if exact same item exists (now including source)
        const existingIndex = cart.findIndex(x => x.id === originalId && x.wo === wo && x.type === type && x.source === source);
            
        if (existingIndex > -1) {
            cart[existingIndex].qty += qty;
        } else {
            cart.push({ 
                ...itemObj, 
                transactionId: crypto.randomUUID(),
                qty: qty,
                wo: wo,
                type: type,
                source: source // New
            });
        }
            
        const originalText = addButton.innerText;
        addButton.innerText = "Added!";
        addButton.classList.remove('bg-primary-blue', 'hover:bg-blue-700');
        addButton.classList.add('bg-success-green', 'hover:bg-green-700');
        
        document.getElementById(`preview-${safeId}`).innerHTML = generatePreviewHTML(originalId);
        updateCartCounter();
        
        qtyInput.value = 1;

        setTimeout(() => {
            addButton.innerText = originalText;
            addButton.classList.add('bg-primary-blue', 'hover:bg-blue-700');
            addButton.classList.remove('bg-success-green', 'hover:bg-green-700');
        }, 800);
    }

    function removeFromCartById(transactionId) {
        const index = cart.findIndex(item => item.transactionId === transactionId);
        if (index > -1) {
            cart.splice(index, 1);
            renderReview();
            updateCartCounter();
            // Also update the preview tags on the selection screen
            filterMaterials();
        }
    }
    
    window.removeFromCartById = removeFromCartById;


    // --- 7. NAVIGATION & REVIEW ---
    function goToReview() {
        if (cart.length === 0) {
            showCustomAlert("Your Review List is empty. Please add items on the selection screen.", "Empty List");
            return;
        }
        document.getElementById('view-toc').classList.add('hidden');
        document.getElementById('view-selection').classList.add('hidden');
        document.getElementById('view-review').classList.remove('hidden');
        renderReview();
    }
    
    window.goToReview = goToReview;


    function goBack() {
        document.getElementById('view-review').classList.add('hidden');
        document.getElementById('view-selection').classList.remove('hidden');
        // We don't go to TOC, we go back to the selection list we were just on.
        // We also don't clear the category filter, allowing the user to resume where they left off.
        filterMaterials(); // Re-render material list to update any previews
    }
    
    window.goBack = goBack;

    function renderReview() {
        document.getElementById('totalItemsCount').innerText = cart.length;
        const tbody = document.getElementById('reviewTableBody');
        tbody.innerHTML = "";

        const sortedCart = [...cart].sort((a, b) => a.wo.localeCompare(b.wo));

        sortedCart.forEach(item => {
            const badgeClass = item.type === 'Issue' ? 'bg-green-100 text-success-green' : 'bg-red-100 text-danger-red';

            tbody.innerHTML += `
                <tr class="hover:bg-gray-50 transition duration-100 border-b border-gray-100">
                    <td class="py-3 px-4 font-mono text-sm">${item.wo}</td>
                    <td class="py-3 px-4"><span class="px-2 py-1 rounded-md text-xs font-semibold ${badgeClass}">${item.type}</span></td>
                    <td class="py-3 px-4 text-sm text-gray-700">${item.source}</td>
                    <td class="py-3 px-4 font-bold text-gray-800">${item.cu}</td>
                    <td class="py-3 px-4 text-sm text-gray-600">${item.desc}</td>
                    <td class="py-3 px-4 font-extrabold">${item.qty}</td>
                    <td class="py-3 px-4">
                        <button class="px-3 py-1 bg-danger-red text-white font-medium rounded-md text-xs hover:bg-red-600 transition" onclick="removeFromCartById('${item.transactionId}')">Remove</button>
                    </td>
                </tr>
            `;
        });
    }

    // --- 8. EMAIL EXPORT ---
    function openEmailDraft() {
        const emailTo = ""; 
        const uniqueWOs = [...new Set(cart.map(i => i.wo))];
        const subject = `Material Transaction Request - WOs: ${uniqueWOs.join(', ')}`;
        
        let body = `MATERIAL TRANSACTION REPORT\n`;
        body += `Generated on: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}\n`;
        body += `\nSUMMARY OF TRANSACTIONS (${cart.length} Total):\n`;
        body += `========================================================================\n`;
        
        const sortedCart = [...cart].sort((a, b) => a.wo.localeCompare(b.wo) || a.type.localeCompare(b.type));

        sortedCart.forEach(item => {
            const typeLabel = item.type === 'Issue' ? 'ISSUE ' : 'CREDIT';
            const woPad = item.wo.padEnd(10, ' ');
            const typePad = typeLabel.padEnd(6, ' ');
            const srcPad = item.source.padEnd(15, ' '); // Padding for alignment
            
            // UPDATED: Removed Description. Added CU (using item.id for letters) and ID (using item.cu for numbers).
            body += `WO: ${woPad} | ${typePad} | Loc: ${srcPad} | ID: ${item.cu.padEnd(15, ' ')} | CU: ${item.id.padEnd(15, ' ')} | Qty: ${item.qty}\n`;
        });
        
        body += `\n========================================================================\n`;
        body += `End of Report.`;
        
        const mailtoLink = `mailto:${emailTo}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.location.href = mailtoLink;
        
        showCustomAlert("The email client should now open with your prepared material request list.", "Email Draft Prepared");
    }
    
    window.openEmailDraft = openEmailDraft;

    // --- 9. CSV EXPORT ---
    function downloadCSV() {
        if (cart.length === 0) {
            showCustomAlert("No items to export.", "Empty Cart");
            return;
        }

        // Define CSV Headers (Updated Order as requested)
        // 1.Date, 2.Blank, 3.WO, 4.Material ID, 5.Description, 6.Qty, 7.Type, 8.Location
        const headers = ["Date", "", "WO Number", "Material ID", "Material Description", "Quantity", "Transaction Type", "Location"];
        
        // Get current date in MM/DD/YYYY format
        const now = new Date();
        const dateStr = `${now.getMonth() + 1}/${now.getDate()}/${now.getFullYear()}`;

        // Sort data same as email (by WO)
        const sortedCart = [...cart].sort((a, b) => a.wo.localeCompare(b.wo) || a.type.localeCompare(b.type));

        // Map data to CSV rows
        const rows = sortedCart.map(item => [
            `"${dateStr}"`,       // 1. Date
            "",                   // 2. Blank Column
            `"${item.wo}"`,       // 3. WO Number
            `"${item.cu}"`,       // 4. Material ID (matches app's "ID" field)
            `"${item.desc}"`,     // 5. Material Description
            item.qty,             // 6. Quantity
            `"${item.type}"`,     // 7. Issue/Credit
            `"${item.source}"`    // 8. Location
        ]);

        // Combine headers and rows
        const csvContent = [
            headers.join(","),
            ...rows.map(r => r.join(","))
        ].join("\n");

        // Create the file blob and trigger download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", `Material_Transaction_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    window.downloadCSV = downloadCSV;

</script>
</body>
</html>
